generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model SiteSettings {
  id        Int       @id @default(autoincrement())
  key       String    @unique
  value     Boolean
  updatedAt DateTime? @default(now()) @db.Timestamp(0)
  createdAt DateTime  @default(now()) @db.Timestamp(0)
}

model User {
  id                        Int                      @id @default(autoincrement())
  uid                       String                   @unique
  nationalId                String?
  avatar                    String?
  isNationalVerified        Boolean                  @default(false)
  email                     String?                  @unique
  firstName                 String?
  lastName                  String?
  mobile                    String                   @unique
  password                  String?
  loginFrom                 String?                  @default("HEALTH_PAY")
  lastLogin                 DateTime?                @default(now())
  isVerified                Boolean                  @default(false)
  createdFrom               String?                  @default("HEALTH_PAY")
  createdAt                 DateTime                 @default(now())
  updatedAt                 DateTime?                @default(now()) @updatedAt
  prefLang                  String?                  @default("en")
  cashInOpsId               Int?
  cashOutOpsId              Int?
  transferOpsId             Int?
  remember_token            String?                  @db.Text
  nationalDocBack           String?
  nationalDocFront          String?
  nationalDoc               String?                  @db.VarChar(101)
  isDeactivated             Boolean?                 @default(false)
  isAgent                   Boolean?                 @default(false)
  two_factor_secret         String?                  @db.Text
  two_factor_recovery_codes String?                  @db.Text
  attachedMerchantId        Int?
  attachedMerchants         Merchant?                @relation("UserAttachedToMerchant", fields: [attachedMerchantId], references: [id])
  cashInOps                 Operation?               @relation("UserCashInOps", fields: [cashInOpsId], references: [id])
  cashOutOps                Operation?               @relation("UserCashOutOps", fields: [cashOutOpsId], references: [id])
  transferOps               Operation?               @relation("UserTransferOps", fields: [transferOpsId], references: [id])
  cashOutRequest            CashOutRequest[]
  cashOutSettings           CashOutSettings[]
  financingRequest          FinancingRequest[]
  merchants                 Merchant[]
  MerchantAdmins            MerchantAdmins[]
  notifications             Notification[]
  otp                       OTP[]
  cards                     Card[]
  medCards                  MedCard[]
  paymentRequests           PaymentRequest[]         @relation("UserPaymentRequests")
  sentPaymentRequests       PaymentRequest[]         @relation("UserSentPaymentRequests")
  agentPaymentRequests      PaymentRequest[]         @relation("AgentPaymentRequests")
  agentActivityLogs         ActivityLogs[]
  providersAuthMerchant     ProviderAuthMerchant[]
  transactions              Transaction[]
  usersAuthMerchant         UserAuthMerchant[]
  notifyTokens              UserNotifyTokens[]
  verificationRequest       UserVerificationRequest?
  wallet                    Wallet?
  deviceTokens              DeviceTokens[]
  AuctionUsers              AuctionUsers[]
  EarlyPaymentRequests      EarlyPaymentRequest[]
}

model Card {
  id        Int       @id @default(autoincrement())
  user_id   Int       @unique
  user      User      @relation(fields: [user_id], references: [id])
  createdAt DateTime  @default(now())
  updatedAt DateTime? @default(now()) @updatedAt
}

model DeviceTokens {
  id        Int       @id @default(autoincrement())
  token     String?   @unique @db.VarChar(200)
  user_id   Int
  user      User      @relation(fields: [user_id], references: [id])
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime? @default(now()) @updatedAt

  @@unique([user_id, token], name: "user_id_token_unique")
}

model IpActivity {
  id         Int       @id @default(autoincrement())
  ipAddess   String
  merchantId Int?
  action     String?
  ops        String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime? @default(now()) @updatedAt
  merchant   Merchant? @relation(fields: [merchantId], references: [id])
}

model UserVerificationRequest {
  id        Int                 @id @default(autoincrement())
  userId    Int                 @unique
  status    VERIFICATION_STATUS @default(PENDING)
  createdAt DateTime            @default(now())
  updatedAt DateTime?           @default(now()) @updatedAt
  user      User                @relation(fields: [userId], references: [id])
}

model Operation {
  id                    Int                   @id @default(autoincrement())
  uid                   String                @unique
  name                  String?
  img                   String?
  isPercentage          Boolean               @default(true)
  agreement             Float                 @default(1)
  isAgreementPercentage Boolean               @default(true)
  type                  OPERATION_METHOD_TYPE
  payable               Float
  receivable            Float                 @default(100)
  extraFees             Float                 @default(0)
  createdAt             DateTime              @default(now())
  updatedAt             DateTime?             @default(now()) @updatedAt
  cashInUsers           User[]                @relation("UserCashInOps")
  cashOutUsers          User[]                @relation("UserCashOutOps")
  transferUsers         User[]                @relation("UserTransferOps")
}

model MedCard {
  id         Int       @id @default(autoincrement())
  uid        String    @unique
  nationalId String    @unique
  isActive   Boolean   @default(false)
  nameOnCard String
  birthDate  String?
  gender     String?
  relationId String?
  userId     Int?
  img        String?
  merchantId Int?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime? @default(now()) @updatedAt
  user       User?     @relation(fields: [userId], references: [id])
  merchant   Merchant? @relation(fields: [merchantId], references: [id])
}

model UserNotifyTokens {
  id        Int       @id @default(autoincrement())
  token     String
  userId    Int?
  createdAt DateTime  @default(now())
  updatedAt DateTime? @default(now()) @updatedAt
  user      User?     @relation(fields: [userId], references: [id])

  @@unique([token, userId], name: "token_to_user_unique")
}

model Notification {
  id        Int       @id @default(autoincrement())
  msg       String
  userId    Int?
  delivered Boolean   @default(false)
  createdAt DateTime  @default(now())
  updatedAt DateTime? @default(now()) @updatedAt
  msg_ar    String?
  vars      Json?
  user      User?     @relation(fields: [userId], references: [id])
}

model Merchant {
  id                   Int                    @id @default(autoincrement())
  uid                  String                 @unique
  name                 String
  img                  String?
  ownerId              Int
  apiKey               String                 @unique
  apiHeader            String                 @unique
  returnUrl            String
  total                Float                  @default(0)
  createdAt            DateTime               @default(now())
  updatedAt            DateTime?              @default(now()) @updatedAt
  isHp                 MerchantType?          @default(REGULAR)
  whiteListedIps       String?                @db.Text
  owner                User                   @relation(fields: [ownerId], references: [id])
  payableBalance       Balance[]              @relation("PayableMerchantBalance")
  receivableBalance    Balance[]              @relation("ReceivableMerchantBalance")
  ipActivity           IpActivity[]
  activityLogs         ActivityLogs[]
  admins               MerchantAdmins[]
  paymentRequests      PaymentRequest[]
  providers            ProviderAuthMerchant[]
  Transaction          Transaction[]
  users                UserAuthMerchant[]
  attachedAgents       User[]                 @relation("UserAttachedToMerchant")
  MedCard              MedCard[]
  EarlyPaymentRequests EarlyPaymentRequest[]

  @@unique([name, ownerId], name: "name_ownerId_unique")
}

model MerchantAdmins {
  id          Int       @id @default(autoincrement())
  uid         String    @unique
  userId      Int
  merchantId  Int?
  permissions String?   @db.Text
  createdAt   DateTime  @default(now())
  updatedAt   DateTime? @default(now()) @updatedAt
  merchant    Merchant? @relation(fields: [merchantId], references: [id])
  user        User      @relation(fields: [userId], references: [id])
}

model UserAuthMerchant {
  id         Int       @id @default(autoincrement())
  uid        String    @unique
  token      String
  userId     Int
  merchantId Int
  createdAt  DateTime  @default(now())
  updatedAt  DateTime? @default(now()) @updatedAt
  merchant   Merchant  @relation(fields: [merchantId], references: [id])
  user       User      @relation(fields: [userId], references: [id])

  @@unique([merchantId, userId], name: "merchantId_userId_unique")
}

model ProviderAuthMerchant {
  id         Int       @id @default(autoincrement())
  uid        String    @unique
  token      String
  userId     Int
  merchantId Int
  createdAt  DateTime  @default(now())
  updatedAt  DateTime? @default(now()) @updatedAt
  merchant   Merchant  @relation(fields: [merchantId], references: [id])
  user       User      @relation(fields: [userId], references: [id])

  @@unique([merchantId, userId], name: "merchantId_providerId_unique")
}

model Wallet {
  id              Int       @id @default(autoincrement())
  userId          Int       @unique
  total           Float
  createdAt       DateTime  @default(now())
  updatedAt       DateTime? @default(now()) @updatedAt
  financingAmount Float?    @default(0)

  isSubscribable Boolean @default(false)
  isSubscribed   Boolean @default(false)

  user              User                 @relation(fields: [userId], references: [id])
  payableBalance    Balance[]            @relation("PayableBalance")
  receivableBalance Balance[]            @relation("ReceivableBalance")
  subscribedWallets WalletSubscription[] @relation("walletToPayerWallet")
  parentWallets     WalletSubscription[] @relation("walletToPayeeWallet")
}

model FinancingCompany {
  id                Int                @id @default(autoincrement())
  name              String             @unique
  img               String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime?          @default(now()) @updatedAt
  admins            FinancingAdmin[]
  financingRequests FinancingRequest[]
}

model FinancingAdmin {
  id                 Int               @id @default(autoincrement())
  financingCompanyId Int?
  username           String            @unique
  password           String
  name               String
  img                String?
  mobile             String?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime?         @default(now()) @updatedAt
  financingCompany   FinancingCompany? @relation(fields: [financingCompanyId], references: [id])
}

model FinancingRequest {
  id              Int                      @id @default(autoincrement())
  uid             String                   @unique
  userId          Int
  companyId       Int?
  requestedAmount Float
  approvedAmount  Float?
  status          FINANCING_REQUEST_STATUS @default(PENDING)
  reason          String
  fullName        String
  transfered_at   DateTime?
  createdAt       DateTime                 @default(now())
  updatedAt       DateTime?                @default(now()) @updatedAt
  company         FinancingCompany?        @relation(fields: [companyId], references: [id])
  user            User                     @relation(fields: [userId], references: [id])
}

model Balance {
  id                   Int          @id @default(autoincrement())
  uid                  String       @unique
  payableMerchantId    Int?
  receivableMerchantId Int?
  payableWalletId      Int?
  receivableWalletId   Int?
  type                 BALANCE_TYPE @default(U2U)
  amount               Float
  notes                String?      @db.Text
  createdAt            DateTime?    @default(now())
  updatedAt            DateTime?    @updatedAt
  confirmedAt          DateTime?
  rejectedAt           DateTime?
  isDueToWalletSub     Boolean?     @default(false) // if true, then it's due to wallet subscription 
  payableMerchant      Merchant?    @relation("PayableMerchantBalance", fields: [payableMerchantId], references: [id])
  payableWallet        Wallet?      @relation("PayableBalance", fields: [payableWalletId], references: [id])
  receivableMerchant   Merchant?    @relation("ReceivableMerchantBalance", fields: [receivableMerchantId], references: [id])
  receivableWallet     Wallet?      @relation("ReceivableBalance", fields: [receivableWalletId], references: [id])
}

model Transaction {
  id                   Int             @id @default(autoincrement())
  uid                  String          @unique
  iframeUrl            String
  amount               Float
  userId               Int
  status               TRANS_STATUS    @default(PENDING)
  chargeFromMerchantId Int?
  expiredAt            DateTime?
  createdAt            DateTime?       @default(now())
  updatedAt            DateTime?       @updatedAt
  chargeFromMerchant   Merchant?       @relation(fields: [chargeFromMerchantId], references: [id])
  user                 User            @relation(fields: [userId], references: [id])
  dueToRequest         PaymentRequest?
}

model CashOutRequest {
  id              Int              @id @default(autoincrement())
  uid             String           @unique
  amount          Float
  comment         String?          @db.Text
  userId          Int
  status          CASHOUT_STATUS   @default(PENDING)
  createdAt       DateTime?        @default(now())
  updatedAt       DateTime?        @updatedAt
  cashOutMethodId Int?
  cashOutMethod   CashOutSettings? @relation(fields: [cashOutMethodId], references: [id])
  user            User             @relation(fields: [userId], references: [id])
}

model CashOutSettings {
  id              Int              @id @default(autoincrement())
  uid             String           @unique
  userId          Int?
  typeId          Int?
  creditorNo      String
  createdAt       DateTime         @default(now())
  updatedAt       DateTime?        @default(now())
  type            CashOutTypes?    @relation(fields: [typeId], references: [id])
  user            User?            @relation(fields: [userId], references: [id])
  cashOutRequests CashOutRequest[]
}

model CashOutTypes {
  id              Int                 @id @default(autoincrement())
  name            String              @unique
  abbreviation    String?
  bic             String?
  notes           String?
  createdAt       DateTime?           @default(now())
  updatedAt       DateTime?           @updatedAt
  cashOutSettings CashOutSettings[]
  length          CashOutTypeLength[]
}

model CashOutTypeLength {
  id          Int            @id @default(autoincrement())
  length      Int
  createdAt   DateTime?      @default(now())
  updatedAt   DateTime?      @updatedAt
  cashOutType CashOutTypes[]
}

model OTP {
  id        Int       @id @default(autoincrement())
  otp       String
  userId    Int?
  isUsed    Boolean   @default(false)
  createdAt DateTime  @default(now())
  updatedAt DateTime? @default(now()) @updatedAt
  user      User?     @relation(fields: [userId], references: [id])
}

model Admin {
  id                        Int       @id @default(autoincrement())
  name                      String
  email                     String    @unique
  mobile                    String?
  email_verified_at         DateTime? @default(now())
  password                  String
  remember_token            String?   @db.Text
  profile_phone_path        String?
  two_factor_secret         String?   @db.Text
  two_factor_recovery_codes String?   @db.Text
  created_at                DateTime  @default(now())
  updated_at                DateTime? @default(now()) @updatedAt
  last_login                DateTime? @default(now())
}

model Password_resets {
  id         Int       @id @default(autoincrement())
  email      String
  token      String?
  created_at DateTime? @default(now())
}

model personal_access_tokens {
  id             Int       @id @default(autoincrement())
  tokenable_id   String?
  tokenable_type String?
  name           String?
  token          String    @unique
  abilities      String?   @db.Text
  last_used_at   DateTime? @default(now())
  created_at     DateTime  @default(now())
  updated_at     DateTime? @default(now()) @updatedAt
}

model Sessions {
  id            String  @unique
  user_id       Int?
  ip_address    String? @db.Text
  user_agent    String? @db.Text
  payload       String  @db.Text
  last_activity Int
}

model PaymentRequest {
  id            Int                   @id @default(autoincrement())
  uid           String                @unique
  amount        Float
  status        PaymentRequest_status @default(PENDING)
  note          String?               @db.LongText
  consent       PaymentRequestConsent @default(FORCED)
  userId        Int?
  merchantId    Int?
  senderId      Int?
  transactionId Int?                  @unique
  agentId       Int?
  createdAt     DateTime              @default(now())
  updatedAt     DateTime?             @default(now()) @updatedAt
  merchant      Merchant?             @relation(fields: [merchantId], references: [id])
  transaction   Transaction?          @relation(fields: [transactionId], references: [id])
  user          User?                 @relation("UserPaymentRequests", fields: [userId], references: [id])
  sender        User?                 @relation("UserSentPaymentRequests", fields: [senderId], references: [id])
  agent         User?                 @relation("AgentPaymentRequests", fields: [agentId], references: [id])
}

model ActivityLogs {
  id            Int       @id @default(autoincrement())
  userId        Int?
  merchantId    Int?
  activity_json String?   @db.Text
  createdAt     DateTime  @default(now())
  updatedAt     DateTime? @default(now()) @updatedAt
  user          User?     @relation(fields: [userId], references: [id])
  merchant      Merchant? @relation(fields: [merchantId], references: [id])
}

model BillPaymentService {
  id        Int       @id @default(autoincrement())
  data      Json      @db.Json
  name      String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime? @default(now()) @updatedAt
}

model UserPayoutServiceRequest {
  id        Int          @id @default(autoincrement())
  uid       String       @unique
  userId    Int?
  status    TRANS_STATUS @default(PENDING)
  serviceId Int?
  fields    Json?        @db.Json
  response  Json?        @db.Json
  createdAt DateTime     @default(now())
  updatedAt DateTime?    @default(now()) @updatedAt
}

model WalletSubscription {
  id            Int @id @default(autoincrement())
  payerWalletId Int
  payeeWalletId Int

  payerWallet Wallet? @relation("walletToPayerWallet", fields: [payerWalletId], references: [id])
  payeeWallet Wallet? @relation("walletToPayeeWallet", fields: [payeeWalletId], references: [id])

  activeTo  DateTime?
  status    WalletSubscriptionStatus @default(INVITED)
  isDefault Boolean                  @default(false)

  strategy String? @default("DEFAULT")

  createdAt DateTime  @default(now())
  updatedAt DateTime? @default(now()) @updatedAt

  @@unique([payerWalletId, payeeWalletId], name: "walletToSubWallet_unique")
}

model AuctionOffers {
  id Int @id @default(autoincrement())

  price  Float
  status AuctionOffersStatus @default(PENDING)
  img    String?
  name   String

  desc          String? @db.Text
  maxApplicants Int     @default(0)

  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @default(now()) @updatedAt
  AuctionUsers AuctionUsers[]
}

model AuctionUsers {
  id Int @id @default(autoincrement())

  userId  Int
  offerId Int

  isWinner Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  user  User          @relation(fields: [userId], references: [id])
  offer AuctionOffers @relation(fields: [offerId], references: [id])

  @@unique([userId, offerId], name: "user_offer_unique")
}

model EarlyPaymentRequest {
  id             Int                   @id @default(autoincrement())
  uid            String                @unique
  userId         Int
  amount         Float
  acceptedamount Float?
  name           String?
  details        String?
  attachments    Json?                 @db.Json
  merchantId     Int
  status         PaymentRequestConsent
  createdAt      DateTime              @default(now())
  updatedAt      DateTime?             @default(now()) @updatedAt
  user           User                  @relation(fields: [userId], references: [id])
  merchant       Merchant              @relation(fields: [merchantId], references: [id])
}

enum PaymentRequestConsent {
  FORCED
  ACCEPTED
  PENDING
  DECLINED
}

enum MerchantType {
  CASHOUT
  PROFIT
  CASHIN
  REGULAR
}

enum TRANS_STATUS {
  PENDING
  CANCELLED
  COMPLETED
  DECLINED
}

enum VERIFICATION_STATUS {
  PENDING
  VERIFIED
  SUSPENDED
  BLACKLIST
}

enum OPERATION_METHOD_TYPE {
  CASH_IN
  CASH_OUT
  TRANSFER
}

enum CASHOUT_STATUS {
  PENDING
  CANCELLED
  APPROVED
  DECLINED
}

enum FINANCING_REQUEST_STATUS {
  INPROGRESS
  PENDING
  CANCELLED
  APPROVED
  DECLINED
}

enum BALANCE_TYPE {
  M2M
  M2P
  P2M
  U2M
  P2U
  M2U
  U2U
  CASH_IN
  CASH_OUT
  REFUND
  CASH_OUT_FAILED
}

enum PaymentRequest_status {
  PENDING
  CANCELLED
  APPROVED
  DECLINED
}

enum WalletSubscriptionStatus {
  INVITED
  ACTIVE
  INACTIVE
  SUSPENDED
  CANCELLED
}

enum AuctionOffersStatus {
  PENDING
  CANCELLED
  COMPLETED
  DECLINED
}
