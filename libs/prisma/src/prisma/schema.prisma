generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model SiteSettings {
  id    Int     @id @default(autoincrement())
  key   String  @unique
  value Boolean
}

model User {
  id                    Int                      @id @default(autoincrement())
  uid                   String                   @unique
  nationalId            String?
  nationalDocFront      String?
  nationalDocBack       String?
  avatar                String?
  isNationalVerified    Boolean                  @default(false)
  email                 String?                  @unique
  firstName             String?
  lastName              String?
  mobile                String                   @unique
  password              String?
  loginFrom             String?                  @default("HEALTH_PAY")
  lastLogin             DateTime?                @default(now())
  isVerified            Boolean                  @default(false)
  verificationRequest   UserVerificationRequest?
  createdFrom           String?                  @default("HEALTH_PAY")
  prefLang              String?                  @default("en")
  remember_token        String?                  @db.Text
  otp                   OTP[]
  notifyTokens          UserNotifyTokens[]
  notifications         Notification[]
  wallet                Wallet?
  paymentRequests       PaymentRequest[]
  merchants             Merchant[]
  usersAuthMerchant     UserAuthMerchant[]
  providersAuthMerchant ProviderAuthMerchant[]
  transactions          Transaction[]
  cashOutRequest        CashOutRequest[]
  cashOutSettings       CashOutSettings[]
  cashInOps             Operation?               @relation(fields: [cashInOpsId], references: [id], name: "UserCashInOps")
  cashInOpsId           Int?
  cashOutOps            Operation?               @relation(fields: [cashOutOpsId], references: [id], name: "UserCashOutOps")
  cashOutOpsId          Int?
  transferOps           Operation?               @relation(fields: [transferOpsId], references: [id], name: "UserTransferOps")
  transferOpsId         Int?
  financingRequest      FinancingRequest[]
  createdAt             DateTime                 @default(now())
  updatedAt             DateTime?                @default(now()) @updatedAt


  MerchantAdmins MerchantAdmins[]
}

model IpActivity {
  id         Int       @id @default(autoincrement())
  ipAddess   String
  merchant   Merchant? @relation(fields: [merchantId], references: [id])
  merchantId Int?
  action     String?
  ops        String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime? @default(now()) @updatedAt

}

model UserVerificationRequest {
  id        Int                 @id @default(autoincrement())
  userId    Int                 @unique
  user      User                @relation(fields: [userId], references: [id])
  status    VERIFICATION_STATUS @default(PENDING)
  createdAt DateTime            @default(now())
  updatedAt DateTime?           @default(now()) @updatedAt


}

model Operation {
  id                    Int                   @id @default(autoincrement())
  uid                   String                @unique
  name                  String?
  img                   String?
  isPercentage          Boolean               @default(true)
  agreement             Float                 @default(1)
  isAgreementPercentage Boolean               @default(true)
  type                  OPERATION_METHOD_TYPE
  payable               Float
  receivable            Float                 @default(100)
  extraFees             Float                 @default(0)
  cashInUsers           User[]                @relation("UserCashInOps")
  cashOutUsers          User[]                @relation("UserCashOutOps")
  transferUsers         User[]                @relation("UserTransferOps")
  createdAt             DateTime              @default(now())
  updatedAt             DateTime?             @default(now()) @updatedAt

}

model UserNotifyTokens {
  id        Int       @id @default(autoincrement())
  token     String
  userId    Int?
  user      User?     @relation(fields: [userId], references: [id])
  createdAt DateTime  @default(now())
  updatedAt DateTime? @default(now()) @updatedAt

  @@unique([token, userId], name: "token_to_user_unique")
}

model Notification {
  id        Int       @id @default(autoincrement())
  msg       String
  msg_ar    String?
  vars      Json?
  userId    Int?
  delivered Boolean   @default(false)
  user      User?     @relation(fields: [userId], references: [id])
  createdAt DateTime  @default(now())
  updatedAt DateTime? @default(now()) @updatedAt
}

model Merchant {
  id                Int                    @id @default(autoincrement())
  uid               String                 @unique
  name              String
  img               String?
  owner             User                   @relation(fields: [ownerId], references: [id])
  ownerId           Int
  users             UserAuthMerchant[]
  providers         ProviderAuthMerchant[]
  paymentRequests   PaymentRequest[]
  apiKey            String                 @unique
  apiHeader         String                 @unique
  returnUrl         String
  total             Float                  @default(0)
  isHp              MerchantType?          @default(REGULAR)
  admins            MerchantAdmins[]
  receivableBalance Balance[]              @relation("ReceivableMerchantBalance")
  payableBalance    Balance[]              @relation("PayableMerchantBalance")
  createdAt         DateTime               @default(now())
  updatedAt         DateTime?              @default(now()) @updatedAt
  ipActivity        IpActivity[]
  Transaction       Transaction[]


  @@unique([name, ownerId], name: "name_ownerId_unique")
}

model MerchantAdmins {
  id          Int       @id @default(autoincrement())
  uid         String    @unique
  user        User      @relation(fields: [userId], references: [id])
  userId      Int
  merchant    Merchant? @relation(fields: [merchantId], references: [id])
  merchantId  Int?
  permissions Json?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime? @default(now()) @updatedAt
}

enum MerchantType {
  CASHOUT
  PROFIT
  CASHIN
  REGULAR
}

model UserAuthMerchant {
  id         Int       @id @default(autoincrement())
  uid        String    @unique
  token      String
  user       User      @relation(fields: [userId], references: [id])
  userId     Int
  merchant   Merchant  @relation(fields: [merchantId], references: [id])
  merchantId Int
  createdAt  DateTime  @default(now())
  updatedAt  DateTime? @default(now()) @updatedAt

  @@unique([merchantId, userId], name: "merchantId_userId_unique")
}

model ProviderAuthMerchant {
  id         Int       @id @default(autoincrement())
  uid        String    @unique
  token      String
  user       User      @relation(fields: [userId], references: [id])
  userId     Int
  merchant   Merchant  @relation(fields: [merchantId], references: [id])
  merchantId Int
  createdAt  DateTime  @default(now())
  updatedAt  DateTime? @default(now()) @updatedAt

  @@unique([merchantId, userId], name: "merchantId_providerId_unique")
}

model Wallet {
  id                Int       @id @default(autoincrement())
  userId            Int       @unique
  total             Float
  financingAmount   Float?    @default(0)
  user              User      @relation(fields: [userId], references: [id])
  payableBalance    Balance[] @relation("PayableBalance")
  receivableBalance Balance[] @relation("ReceivableBalance")
  createdAt         DateTime  @default(now())
  updatedAt         DateTime? @default(now()) @updatedAt
}

model FinancingCompany {
  id                Int                @id @default(autoincrement())
  name              String             @unique
  img               String?
  admins            FinancingAdmin[]
  financingRequests FinancingRequest[]
  createdAt         DateTime           @default(now())
  updatedAt         DateTime?          @default(now()) @updatedAt

}

model FinancingAdmin {
  id                 Int               @id @default(autoincrement())
  financingCompany   FinancingCompany? @relation(fields: [financingCompanyId], references: [id])
  financingCompanyId Int?
  username           String            @unique
  password           String
  name               String
  img                String?
  mobile             String?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime?         @default(now()) @updatedAt
}

model FinancingRequest {
  id              Int                      @id @default(autoincrement())
  uid             String                   @unique
  user            User                     @relation(fields: [userId], references: [id])
  userId          Int
  company         FinancingCompany?        @relation(fields: [companyId], references: [id])
  companyId       Int?
  requestedAmount Float
  approvedAmount  Float?
  status          FINANCING_REQUEST_STATUS @default(PENDING)
  reason          String
  fullName        String
  transfered_at   DateTime?
  createdAt       DateTime                 @default(now())
  updatedAt       DateTime?                @default(now()) @updatedAt
}

model Balance {
  id                   Int          @id @default(autoincrement())
  uid                  String       @unique
  payableMerchant      Merchant?    @relation("PayableMerchantBalance", fields: [payableMerchantId], references: [id])
  payableMerchantId    Int?
  receivableMerchant   Merchant?    @relation("ReceivableMerchantBalance", fields: [receivableMerchantId], references: [id])
  receivableMerchantId Int?
  payableWalletId      Int?
  payableWallet        Wallet?      @relation(fields: [payableWalletId], references: [id], name: "PayableBalance")
  receivableWalletId   Int?
  receivableWallet     Wallet?      @relation(fields: [receivableWalletId], references: [id], name: "ReceivableBalance")
  type                 BALANCE_TYPE @default(U2U)
  amount               Float
  notes                String?
  confirmedAt          DateTime?
  rejectedAt           DateTime?
  createdAt            DateTime?    @default(now())
  updatedAt            DateTime?    @updatedAt
}

model Transaction {
  id                   Int             @id @default(autoincrement())
  uid                  String          @unique
  iframeUrl            String
  amount               Float
  user                 User            @relation(fields: [userId], references: [id])
  userId               Int
  status               TRANS_STATUS    @default(PENDING)
  chargeFromMerchant   Merchant?       @relation(fields: [chargeFromMerchantId], references: [id])
  chargeFromMerchantId Int?
  dueToRequest         PaymentRequest?
  expiredAt            DateTime?
  createdAt            DateTime?       @default(now())
  updatedAt            DateTime?       @updatedAt

}

model CashOutRequest {
  id              Int              @id @default(autoincrement())
  uid             String           @unique
  amount          Float
  user            User             @relation(fields: [userId], references: [id])
  userId          Int
  cashOutMethod   CashOutSettings? @relation(fields: [cashOutMethodId], references: [id])
  cashOutMethodId Int?
  status          CASHOUT_STATUS   @default(PENDING)
  createdAt       DateTime?        @default(now())
  updatedAt       DateTime?        @updatedAt
}

model CashOutSettings {
  id              Int              @id @default(autoincrement())
  uid             String           @unique
  user            User?            @relation(fields: [userId], references: [id])
  userId          Int?
  type            CashOutTypes?    @relation(fields: [typeId], references: [id])
  typeId          Int?
  cashOutRequests CashOutRequest[]
  creditorNo      String
  createdAt       DateTime         @default(now())
  updatedAt       DateTime?        @default(now())

}

model CashOutTypes {
  id              Int                 @id @default(autoincrement())
  name            String              @unique
  abbreviation    String?
  bic             String?
  length          CashOutTypeLength[]
  notes           String?
  cashOutSettings CashOutSettings[]
  createdAt       DateTime?           @default(now())
  updatedAt       DateTime?           @updatedAt


}

model CashOutTypeLength {
  id          Int            @id @default(autoincrement())
  length      Int
  cashOutType CashOutTypes[]
  createdAt   DateTime?      @default(now())
  updatedAt   DateTime?      @updatedAt
}

model OTP {
  id        Int       @id @default(autoincrement())
  otp       String
  userId    Int?
  isUsed    Boolean   @default(false)
  user      User?     @relation(fields: [userId], references: [id])
  createdAt DateTime  @default(now())
  updatedAt DateTime? @default(now()) @updatedAt
}

model Admin {
  id                        Int       @id @default(autoincrement())
  name                      String
  mobile                    String?
  email                     String    @unique
  email_verified_at         DateTime? @default(now())
  password                  String
  remember_token            String?   @db.Text
  profile_phone_path        String?
  two_factor_secret         String?   @db.Text
  two_factor_recovery_codes String?   @db.Text
  last_login                DateTime? @default(now())
  created_at                DateTime  @default(now())
  updated_at                DateTime? @default(now()) @updatedAt
}

model Password_resets {
  id         Int       @id @default(autoincrement())
  email      String
  token      String?
  created_at DateTime? @default(now())
}

model personal_access_tokens {
  id             Int       @id @default(autoincrement())
  tokenable_id   String?
  tokenable_type String?
  name           String?
  token          String    @unique
  abilities      String?   @db.Text
  last_used_at   DateTime? @default(now())
  created_at     DateTime  @default(now())
  updated_at     DateTime? @default(now()) @updatedAt
}

model Sessions {
  id            String  @unique
  user_id       Int?
  ip_address    String? @db.Text
  user_agent    String? @db.Text
  payload       String  @db.Text
  last_activity Int
}

model PaymentRequest {
  id            Int            @id @default(autoincrement())
  uid           String         @unique
  amount        Float
  status        CASHOUT_STATUS @default(PENDING)
  userId        Int
  user          User           @relation(fields: [userId], references: [id])
  merchantId    Int
  merchant      Merchant       @relation(fields: [merchantId], references: [id])
  transactionId Int?           @unique
  transaction   Transaction?   @relation(fields: [transactionId], references: [id])
  createdAt     DateTime       @default(now())
  updatedAt     DateTime?      @default(now()) @updatedAt

}

enum TRANS_STATUS {
  PENDING
  CANCELLED
  COMPLETED
  DECLINED
}

enum VERIFICATION_STATUS {
  PENDING
  VERIFIED
  SUSPENDED
  BLACKLIST
}

enum OPERATION_METHOD_TYPE {
  CASH_IN
  CASH_OUT
  TRANSFER
}

enum CASHOUT_STATUS {
  PENDING
  CANCELLED
  APPROVED
  DECLINED
}

enum FINANCING_REQUEST_STATUS {
  INPROGRESS
  PENDING
  CANCELLED
  APPROVED
  DECLINED
}

enum BALANCE_TYPE {
  M2M // merchant to merchant
  M2P // merchant to provider
  P2M // provider to merchant
  U2M // user to merchant
  P2U // provider to user
  M2U // merchant to user
  U2U // user to user
  CASH_IN
  CASH_OUT
  REFUND
  CASH_OUT_FAILED
}
